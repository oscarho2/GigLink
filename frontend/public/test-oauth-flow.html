<!DOCTYPE html>
<html>
<head>
    <title>Google OAuth Flow Test</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 20px 0; padding: 20px; border-radius: 8px; }
        .button { padding: 10px 20px; margin: 10px; background: #4285f4; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .result { margin: 20px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>Google OAuth Flow Test</h1>
    
    <div class="test-section">
        <h2>1. Test Google Sign-In</h2>
        <button id="googleSignIn" class="button">Sign in with Google</button>
        <div id="googleResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Backend Response Analysis</h2>
        <div id="backendResult"></div>
        <div id="responseLog" class="log"></div>
    </div>

    <div class="test-section">
        <h2>3. Navigation Logic Test</h2>
        <div id="navigationResult"></div>
    </div>

    <script>
        const CLIENT_ID = '1024046652559-l4j8i3j2fseoc414ip261lt8po2ooprf.apps.googleusercontent.com';
        let logArea = document.getElementById('responseLog');

        function log(message) {
            const timestamp = new Date().toISOString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(message);
        }

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = 'result ' + type;
            element.innerHTML = message;
        }

        async function handleCredentialResponse(response) {
            log('‚úÖ Google credential received');
            
            try {
                // Decode the JWT to see user info
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                log(`üìß User email: ${payload.email}`);
                log(`üë§ User name: ${payload.name}`);
                
                updateResult('googleResult', `‚úÖ Google Sign-In successful!<br>
                    Email: ${payload.email}<br>
                    Name: ${payload.name}`, 'success');

                // Send to backend
                log('üîÑ Sending to backend...');
                const backendResponse = await fetch('/api/auth/google', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        idToken: response.credential,
                        email: payload.email,
                        name: payload.name,
                        imageUrl: payload.picture
                    })
                });

                const responseData = await backendResponse.json();
                log(`üì® Backend response status: ${backendResponse.status}`);
                log(`üìã Backend response: ${JSON.stringify(responseData, null, 2)}`);

                if (backendResponse.ok) {
                    updateResult('backendResult', 
                        `‚úÖ Backend authentication successful!<br>
                        Profile Complete: <strong>${responseData.user.profileComplete}</strong><br>
                        User ID: ${responseData.user.id}<br>
                        Email Verified: ${responseData.user.isEmailVerified}`, 'success');

                    // Test navigation logic
                    const shouldGoTo = responseData.user.profileComplete ? '/dashboard' : '/profile-setup';
                    updateResult('navigationResult', 
                        `üß≠ Navigation Logic:<br>
                        Profile Complete: ${responseData.user.profileComplete}<br>
                        Should navigate to: <strong>${shouldGoTo}</strong><br>
                        ${!responseData.user.profileComplete ? 
                            '‚úÖ New user will be sent to profile setup!' : 
                            '‚úÖ Existing user will go to dashboard!'
                        }`, 
                        responseData.user.profileComplete ? 'info' : 'success');
                } else {
                    updateResult('backendResult', 
                        `‚ùå Backend error: ${responseData.message}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
                updateResult('googleResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        function initializeGoogleSignIn() {
            if (window.google?.accounts?.id) {
                log('üîß Initializing Google Sign-In...');
                
                window.google.accounts.id.initialize({
                    client_id: CLIENT_ID,
                    callback: handleCredentialResponse,
                    auto_select: false,
                    cancel_on_tap_outside: true
                });

                document.getElementById('googleSignIn').onclick = function() {
                    log('üñ±Ô∏è Sign-in button clicked');
                    updateResult('googleResult', '‚è≥ Starting Google Sign-In...', 'info');
                    
                    window.google.accounts.id.prompt((notification) => {
                        if (notification.isNotDisplayed()) {
                            log(`‚ö†Ô∏è Prompt not displayed: ${notification.getNotDisplayedReason()}`);
                            // Create fallback button
                            const tempDiv = document.createElement('div');
                            tempDiv.style.position = 'absolute';
                            tempDiv.style.left = '-9999px';
                            document.body.appendChild(tempDiv);
                            
                            window.google.accounts.id.renderButton(tempDiv, {
                                type: 'standard',
                                size: 'large',
                                theme: 'outline'
                            });
                            
                            setTimeout(() => {
                                const googleButton = tempDiv.querySelector('[role="button"]');
                                if (googleButton) {
                                    log('üîÑ Using fallback button method');
                                    googleButton.click();
                                }
                            }, 100);
                        }
                    });
                };
                
                log('‚úÖ Google Sign-In initialized successfully');
            } else {
                log('‚ùå Google SDK not available');
                setTimeout(initializeGoogleSignIn, 1000);
            }
        }

        // Initialize when page loads
        window.onload = function() {
            log('üöÄ Page loaded, initializing...');
            initializeGoogleSignIn();
        };
    </script>
</body>
</html>