<!DOCTYPE html>
<html>
<head>
    <title>Test Google Auth - Improved</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <h1>Test Google Authentication (Improved)</h1>
    <button id="signInBtn">Sign in with Google</button>
    <div id="result"></div>

    <script>
        const CLIENT_ID = '1024046652559-l4j8i3j2fseoc414ip261lt8po2ooprf.apps.googleusercontent.com';
        
        function handleCredentialResponse(response) {
            console.log("Encoded JWT ID token: " + response.credential);
            document.getElementById('result').innerHTML = 
                '<p style="color: green;">Success! Token received: ' + 
                response.credential.substring(0, 50) + '...</p>';
        }

        function initializeGoogle() {
            window.google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false,
                cancel_on_tap_outside: true
            });

            // Try One Tap first
            window.google.accounts.id.prompt((notification) => {
                console.log('Notification:', notification);
                if (notification.isNotDisplayed()) {
                    console.log('One Tap not displayed:', notification.getNotDisplayedReason());
                    document.getElementById('result').innerHTML = 
                        '<p style="color: orange;">One Tap not displayed. Reason: ' + 
                        notification.getNotDisplayedReason() + '</p>';
                    renderSignInButton();
                } else if (notification.isSkippedMoment()) {
                    console.log('One Tap skipped');
                    renderSignInButton();
                } else if (notification.isDismissedMoment()) {
                    console.log('One Tap dismissed');
                    renderSignInButton();
                }
            });
        }

        function renderSignInButton() {
            // Create a visible sign-in button as fallback
            const buttonDiv = document.createElement('div');
            buttonDiv.id = 'g_id_signin';
            document.getElementById('signInBtn').parentNode.insertBefore(buttonDiv, 
                document.getElementById('signInBtn').nextSibling);
                
            window.google.accounts.id.renderButton(
                document.getElementById("g_id_signin"),
                { 
                    type: "standard",
                    size: "large",
                    theme: "outline",
                    text: "sign_in_with",
                    shape: "rectangular"
                }
            );
            
            document.getElementById('signInBtn').style.display = 'none';
        }

        document.getElementById('signInBtn').addEventListener('click', function() {
            if (window.google && window.google.accounts) {
                renderSignInButton();
            } else {
                document.getElementById('result').innerHTML = 
                    '<p style="color: red;">Google SDK not loaded yet. Please wait...</p>';
            }
        });

        window.onload = function() {
            if (window.google && window.google.accounts) {
                initializeGoogle();
            } else {
                setTimeout(function() {
                    if (window.google && window.google.accounts) {
                        initializeGoogle();
                    } else {
                        document.getElementById('result').innerHTML = 
                            '<p style="color: red;">Failed to load Google SDK</p>';
                    }
                }, 2000);
            }
        };
    </script>
</body>
</html>